---
// src/pages/premium.astro
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

// Get Stripe publishable key from environment
const stripePublishableKey = import.meta.env.STRIPE_PUBLISHABLE_KEY;
---

<Layout title="Premium Trainer Listing" description="Upgrade to a featured listing and get more visibility for your dog training services in Melbourne.">
    <Header />
    
    <main id="main-content">
        <section class="premium-page">
            <div class="container">
                <div class="page-header">
                    <h1>Get Featured & Stand Out</h1>
                    <p class="page-subtitle">Premium listings appear first in search results and get up to 5x more visibility</p>
                </div>

                <!-- Benefits Section -->
                <section class="benefits-section">
                    <h2>Why Go Premium?</h2>
                    <div class="benefits-grid">
                        <div class="benefit-card">
                            <div class="benefit-icon">üîù</div>
                            <h3>Top Placement</h3>
                            <p>Your listing appears first in all relevant searches and category filters</p>
                        </div>
                        <div class="benefit-card">
                            <div class="benefit-icon">‚≠ê</div>
                            <h3>Featured Badge</h3>
                            <p>Stand out with an eye-catching "Featured" badge on your trainer card</p>
                        </div>
                        <div class="benefit-card">
                            <div class="benefit-icon">üìà</div>
                            <h3>5x More Views</h3>
                            <p>Premium listings receive significantly more profile views and inquiries</p>
                        </div>
                        <div class="benefit-card">
                            <div class="benefit-icon">üéØ</div>
                            <h3>Premium Styling</h3>
                            <p>Enhanced card design with gold border and gradient background</p>
                        </div>
                    </div>
                </section>

                <!-- Pricing Section -->
                <section class="pricing-section">
                    <h2>Simple, Transparent Pricing</h2>
                    <div class="pricing-grid">
                        <div class="pricing-card">
                            <div class="plan-header">
                                <h3>Monthly Premium</h3>
                                <div class="price">
                                    <span class="currency">$</span>
                                    <span class="amount">49</span>
                                    <span class="period">/month</span>
                                </div>
                            </div>
                            <ul class="plan-features">
                                <li>‚úÖ Top placement in search results</li>
                                <li>‚úÖ Featured badge</li>
                                <li>‚úÖ Premium card styling</li>
                                <li>‚úÖ Cancel anytime</li>
                            </ul>
                            <button class="button primary plan-button" data-plan="monthly" data-price-id="price_1RX0QxDEY1RddZfIoRdn84vS">
                                Start Monthly Premium
                            </button>
                        </div>

                        <div class="pricing-card popular">
                            <div class="popular-badge">Best Value</div>
                            <div class="plan-header">
                                <h3>Annual Standard</h3>
                                <div class="price">
                                    <span class="currency">$</span>
                                    <span class="amount">79</span>
                                    <span class="period">/year</span>
                                </div>
                                <div class="savings">Save over 85%</div>
                            </div>
                            <ul class="plan-features">
                                <li>‚úÖ Standard listing features</li>
                                <li>‚úÖ Annual billing discount</li>
                                <li>‚úÖ Priority support</li>
                                <li>‚úÖ Performance analytics</li>
                            </ul>
                            <button class="button primary plan-button" data-plan="annual" data-price-id="price_1RX0T2DEY1RddZfIATD9orLs">
                                Start Annual Standard
                            </button>
                        </div>

                        <div class="pricing-card">
                            <div class="plan-header">
                                <h3>Premium + Standard</h3>
                                <div class="price">
                                    <span class="currency">$</span>
                                    <span class="amount">128</span>
                                    <span class="period">/year + monthly</span>
                                </div>
                                <div class="savings">Complete Package</div>
                            </div>
                            <ul class="plan-features">
                                <li>‚úÖ Annual Standard listing</li>
                                <li>‚úÖ Monthly Premium upgrade</li>
                                <li>‚úÖ Maximum visibility</li>
                                <li>‚úÖ All premium features</li>
                            </ul>
                            <button class="button primary plan-button" data-plan="combo" data-price-id="price_1RX0T2DEY1RddZfIATD9orLs">
                                Get Complete Package
                            </button>
                        </div>
                    </div>
                </section>

                <!-- FAQ Section -->
                <section class="faq-section">
                    <h2>Frequently Asked Questions</h2>
                    <div class="faq-grid">
                        <div class="faq-item">
                            <h3>How quickly will my listing be featured?</h3>
                            <p>Your listing will be featured immediately after successful payment processing, typically within 5 minutes.</p>
                        </div>
                        <div class="faq-item">
                            <h3>Can I cancel my subscription?</h3>
                            <p>Yes! You can cancel anytime. Your listing will remain featured until the end of your current billing period.</p>
                        </div>
                        <div class="faq-item">
                            <h3>What payment methods do you accept?</h3>
                            <p>We accept all major credit cards, debit cards, and digital wallets through our secure Stripe payment processing.</p>
                        </div>
                        <div class="faq-item">
                            <h3>How many featured spots are available?</h3>
                            <p>We limit featured listings to 10 per suburb/category combination to ensure quality and visibility for all premium members.</p>
                        </div>
                    </div>
                </section>

                <!-- CTA Section -->
                <section class="cta-section">
                    <div class="cta-content">
                        <h2>Ready to Get More Clients?</h2>
                        <p>Join hundreds of successful trainers who've boosted their business with premium listings</p>
                        <a href="#pricing-section" class="button primary large">Choose Your Plan</a>
                    </div>
                </section>
            </div>
        </section>
    </main>
    
    <Footer />
</Layout>

<script type="module" define:vars={{ stripePublishableKey }}>
// Plan: Integrate Stripe Checkout for premium subscription purchases
// Implementation:
// 1. Load Stripe.js library and initialize with publishable key
// 2. On button click, call our /api/create-checkout-session endpoint
// 3. Use Stripe.js to redirect to checkout with the returned session ID
// 4. Handle loading states and errors gracefully
// Expected Results:
// - Clicking a plan button creates a Stripe checkout session and redirects to payment
// - After successful payment, webhook automatically updates trainer status in Supabase

document.addEventListener('DOMContentLoaded', async () => {
    // Load Stripe.js with the publishable key from the server
    const stripe = await loadStripe(stripePublishableKey);
    
    if (!stripe) {
        console.error('Failed to load Stripe');
        return;
    }
    
    const planButtons = document.querySelectorAll('.plan-button');
    
    // Get trainer ID from URL parameters or prompt user
    function getTrainerId() {
        const urlParams = new URLSearchParams(window.location.search);
        let trainerId = urlParams.get('trainerId');
        
        if (!trainerId) {
            // For demo purposes, use a default trainer ID or prompt
            trainerId = prompt('Enter your Trainer ID:') || 'demo-trainer-123';
        }
        
        return trainerId;
    }
    
    planButtons.forEach(button => {
        button.addEventListener('click', async (e) => {
            e.preventDefault();
            
            const priceId = e.target.dataset.priceId;
            const plan = e.target.dataset.plan;
            const trainerId = getTrainerId();
            
            if (!priceId || !trainerId) {
                alert('Missing required information. Please try again.');
                return;
            }
            
            // Disable button during processing
            const originalText = e.target.textContent;
            e.target.disabled = true;
            e.target.textContent = 'Creating checkout session...';
            
            try {
                console.log(`Creating checkout session for plan: ${plan}, priceId: ${priceId}, trainerId: ${trainerId}`);
                
                // Call our checkout session API
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        priceId: priceId,
                        trainerId: trainerId
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create checkout session');
                }
                
                if (data.sessionId) {
                    // Redirect to Stripe Checkout using Stripe.js
                    console.log('Redirecting to Stripe Checkout...');
                    e.target.textContent = 'Redirecting to payment...';
                    
                    const { error } = await stripe.redirectToCheckout({
                        sessionId: data.sessionId
                    });
                    
                    if (error) {
                        throw new Error(error.message);
                    }
                } else {
                    throw new Error('No session ID returned from server');
                }
                
            } catch (error) {
                console.error('Error creating checkout session:', error);
                alert(`Error: ${error.message}`);
                
                // Re-enable button
                e.target.disabled = false;
                e.target.textContent = originalText;
            }
        });
    });
    
    // Handle successful payment redirect
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');
    
    if (sessionId) {
        // Show success message
        const successMessage = document.createElement('div');
        successMessage.className = 'success-message';
        successMessage.innerHTML = `
            <div class="success-content">
                <h3>üéâ Payment Successful!</h3>
                <p>Your premium subscription has been activated. You should see the changes in your listing within a few minutes.</p>
                <button onclick="this.parentElement.parentElement.remove()" class="button">Close</button>
            </div>
        `;
        document.body.insertBefore(successMessage, document.body.firstChild);
        
        // Remove session_id from URL
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
});

// Load Stripe.js from CDN
function loadStripe(publishableKey) {
    return new Promise((resolve) => {
        if (window.Stripe) {
            resolve(window.Stripe(publishableKey));
            return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://js.stripe.com/v3/';
        script.onload = () => {
            resolve(window.Stripe(publishableKey));
        };
        script.onerror = () => {
            resolve(null);
        };
        document.head.appendChild(script);
    });
}
</script>

<style>
    /* Add success message styling */
    .success-message {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .success-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
        max-width: 400px;
        margin: 1rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .success-content h3 {
        color: var(--color-accent-teal);
        margin-bottom: 1rem;
    }
    
    .success-content p {
        margin-bottom: 1.5rem;
        color: var(--color-text-light);
    }

<style>
    .premium-page {
        padding: 3rem 0;
        min-height: 70vh;
    }

    .page-header {
        text-align: center;
        margin-bottom: 4rem;
    }

    .page-header h1 {
        font-size: 3.5em;
        color: var(--color-text-light);
        margin-bottom: 1rem;
        background: linear-gradient(135deg, var(--color-accent-mustard), var(--color-accent-teal));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .page-subtitle {
        font-size: 1.3em;
        color: var(--color-text-light);
        opacity: 0.8;
        max-width: 600px;
        margin: 0 auto;
    }

    /* Benefits Section */
    .benefits-section {
        margin-bottom: 5rem;
    }

    .benefits-section h2 {
        text-align: center;
        margin-bottom: 3rem;
        font-size: 2.5em;
    }

    .benefits-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
    }

    .benefit-card {
        background: var(--color-card-bg-light);
        border: 1px solid var(--color-border-light);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .benefit-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .benefit-icon {
        font-size: 3em;
        margin-bottom: 1rem;
    }

    .benefit-card h3 {
        margin-bottom: 1rem;
        color: var(--color-text-light);
    }

    .benefit-card p {
        color: var(--color-text-light);
        opacity: 0.8;
    }

    /* Pricing Section */
    .pricing-section {
        margin-bottom: 5rem;
    }

    .pricing-section h2 {
        text-align: center;
        margin-bottom: 3rem;
        font-size: 2.5em;
    }

    .pricing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 2rem;
        max-width: 1000px;
        margin: 0 auto;
    }

    .pricing-card {
        background: var(--color-card-bg-light);
        border: 2px solid var(--color-border-light);
        border-radius: 16px;
        padding: 2.5rem;
        text-align: center;
        position: relative;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .pricing-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }

    .pricing-card.popular {
        border-color: var(--color-accent-mustard);
        background: linear-gradient(135deg, 
            var(--color-card-bg-light) 0%, 
            color-mix(in srgb, var(--color-accent-mustard) 3%, var(--color-card-bg-light)) 100%
        );
    }

    .popular-badge {
        position: absolute;
        top: -15px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--color-accent-mustard);
        color: var(--color-text-light);
        padding: 0.5em 1.5em;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(232, 185, 79, 0.3);
    }

    .plan-header h3 {
        font-size: 1.5em;
        margin-bottom: 1rem;
        color: var(--color-text-light);
    }

    .price {
        margin-bottom: 0.5rem;
    }

    .currency {
        font-size: 1.2em;
        vertical-align: top;
        color: var(--color-text-light);
    }

    .amount {
        font-size: 3em;
        font-weight: 700;
        color: var(--color-text-light);
    }

    .period {
        font-size: 1em;
        color: var(--color-text-light);
        opacity: 0.7;
    }

    .savings {
        color: var(--color-accent-teal);
        font-weight: 600;
        font-size: 0.9em;
        margin-bottom: 1.5rem;
    }

    .plan-features {
        list-style: none;
        padding: 0;
        margin: 2rem 0;
        text-align: left;
    }

    .plan-features li {
        padding: 0.5rem 0;
        color: var(--color-text-light);
    }

    .plan-button {
        width: 100%;
        margin-top: 1.5rem;
        padding: 1rem 2rem;
        font-size: 1.1em;
    }

    /* FAQ Section */
    .faq-section {
        margin-bottom: 5rem;
    }

    .faq-section h2 {
        text-align: center;
        margin-bottom: 3rem;
        font-size: 2.5em;
    }

    .faq-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
    }

    .faq-item {
        background: var(--color-card-bg-light);
        border: 1px solid var(--color-border-light);
        border-radius: 12px;
        padding: 2rem;
        box-shadow: var(--shadow-sm);
    }

    .faq-item h3 {
        margin-bottom: 1rem;
        color: var(--color-text-light);
        font-size: 1.2em;
    }

    .faq-item p {
        color: var(--color-text-light);
        opacity: 0.8;
        line-height: 1.6;
    }

    /* CTA Section */
    .cta-section {
        background: linear-gradient(135deg, var(--color-accent-teal), var(--color-accent-mustard));
        border-radius: 16px;
        padding: 4rem 2rem;
        text-align: center;
        color: white;
    }

    .cta-content h2 {
        margin-bottom: 1rem;
        color: white;
        font-size: 2.5em;
    }

    .cta-content p {
        font-size: 1.2em;
        margin-bottom: 2rem;
        opacity: 0.9;
    }

    .button.large {
        padding: 1.2em 3em;
        font-size: 1.2em;
        background: white;
        color: var(--color-text-light);
    }

    .button.large:hover {
        background: var(--color-background-light);
        transform: translateY(-3px);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .page-header h1 {
            font-size: 2.5em;
        }
        
        .pricing-grid {
            grid-template-columns: 1fr;
        }
        
        .benefits-grid {
            grid-template-columns: 1fr;
        }
        
        .faq-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
